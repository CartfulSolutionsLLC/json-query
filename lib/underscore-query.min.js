(function(){var e,r,t,n,u,s,a,i,o,c,l,f,y,p,$,d,h,g,k,m,v,b,w,x,O,q,Q={}.hasOwnProperty;for(m=this,q={},n=function(e){var r,t,n,u;for(u=["every","some","filter","first","find","reject","reduce","intersection","isEqual","keys","isArray","result","map","includes"],r=0,n=u.length;n>r;r++)if(t=u[r],q[t]=e[t],!q[t])throw new Error(t+" missing. Please ensure that you first initialize underscore-query with either lodash or underscore")},q.getType=function(e){var r;return r=Object.prototype.toString.call(e).substr(8),r.substr(0,r.length-1)},q.makeObj=function(e,r){var t;return(t={})[e]=r,t},q.reverseString=function(e){return e.toLowerCase().split("").reverse().join("")},q.compoundKeys=["$and","$not","$or","$nor"],q.expectedArrayQueries=["$and","$or","$nor"],c=function(e,r){var t,n,u,s,a,i;for(a=r,n=t=0,s=e.length;s>t;n=++t)if(u=e[n],q.isArray(a))i=e.slice(n),a=q.map(a,function(e){return c(i,e)});else{if(!a)break;a=q.result(a,u)}return a},q.makeGetter=function(e){return e=e.split("."),function(r){return c(e,r)}},f=function(e,r){var t,n,u;t=[];for(n in r)u=r[n],t.push(q.makeObj(e,q.makeObj(n,u)));return t},p=function(e){var r,t,n,u,s,a,i;s=[];for(r in e)if(Q.call(e,r)){switch(u=e[r],t={key:r},(null!=u?u.$boost:void 0)&&(t.boost=u.$boost,delete u.$boost),-1!==r.indexOf(".")&&(t.getter=q.makeGetter(r)),n=q.getType(u)){case"RegExp":case"Date":t.type="$"+n.toLowerCase(),t.value=u;break;case"Object":if(q.includes(q.compoundKeys,r))t.type=r,t.value=d(u,r),t.key=null;else if(q.keys(u).length>1)t.type="$and",t.value=d(f(r,u)),t.key=null;else for(a in u)if(Q.call(u,a)){if(i=u[a],!O(a,i))throw new Error("Query value ("+i+") doesn't match query type: ("+a+")");switch(t.type=a,a){case"$elemMatch":t.value=w($(i));break;case"$endsWith":t.value=q.reverseString(i);break;case"$likeI":case"$startsWith":t.value=i.toLowerCase();break;case"$not":case"$nor":case"$or":case"$and":t.value=d(q.makeObj(t.key,i)),t.key=null;break;case"$computed":t=q.first(p(q.makeObj(r,i))),t.getter=q.makeGetter(r);break;default:t.value=i}}break;default:t.type="$equal",t.value=u}"$equal"===t.type&&q.includes(["Object","Array"],n)&&(t.type="$deepEqual"),s.push(t)}return s},d=function(e,r){var t,n,u,s;return u=q.isArray(e)?e:function(){var r;r=[];for(n in e)Q.call(e,n)&&(s=e[n],r.push(q.makeObj(n,s)));return r}(),t=function(e,t){var n;return n=p(t),"$or"===r&&n.length>=2?(e.push({type:"$and",parsedQuery:n}),e):e.concat(n)},q.reduce(u,t,[])},O=function(e,r){var t;switch(t=q.getType(r),e){case"$in":case"$nin":case"$all":case"$any":return"Array"===t;case"$size":return"Number"===t;case"$regex":case"$regexp":return"RegExp"===t;case"$like":case"$likeI":return"String"===t;case"$between":case"$mod":return"Array"===t&&2===r.length;case"$cb":return"Function"===t;default:return!0}},x=function(e,r){var t;switch(t=q.getType(r),e){case"$like":case"$likeI":case"$regex":case"$startsWith":case"$endsWith":return"String"===t;case"$contains":case"$all":case"$any":case"$elemMatch":return"Array"===t;case"$size":return q.includes(["String","Array"],t);case"$in":case"$nin":return null!=r;default:return!0}},h=function(e,r,t,n,u){switch(e){case"$and":case"$or":case"$nor":case"$not":return g(e,r,u,n);case"$cb":return r.call(n,t);case"$elemMatch":return v(t,r,null,!0)}switch("function"==typeof r&&(r=r()),e){case"$equal":return q.isArray(t)?q.includes(t,r):t===r;case"$deepEqual":return q.isEqual(t,r);case"$contains":return q.includes(t,r);case"$ne":return t!==r;case"$lt":return null!=r&&r>t;case"$gt":return null!=r&&t>r;case"$lte":return null!=r&&r>=t;case"$gte":return null!=r&&t>=r;case"$between":return null!=r[0]&&null!=r[1]&&r[0]<t&&t<r[1];case"$betweene":return null!=r[0]&&null!=r[1]&&r[0]<=t&&t<=r[1];case"$in":return q.includes(r,t);case"$nin":return!q.includes(r,t);case"$all":return q.every(r,function(e){return q.includes(t,e)});case"$any":return q.some(t,function(e){return q.includes(r,e)});case"$size":return t.length===r;case"$exists":case"$has":return null!=t===r;case"$like":return-1!==t.indexOf(r);case"$likeI":return-1!==t.toLowerCase().indexOf(r);case"$startsWith":return 0===t.toLowerCase().indexOf(r);case"$endsWith":return 0===q.reverseString(t).indexOf(r);case"$type":return typeof t===r;case"$regex":case"$regexp":return r.test(t);case"$mod":return t%r[0]===r[1];default:return!1}},w=function(e,r,t){var n,u;if("String"===q.getType(r)&&(n=r,r=function(e,r){return e[n](r)}),t){if(1!==e.length)throw new Error("score operations currently don't work on compound queries");if(u=e[0],"$and"!==u.type)throw new Error("score operations only work on $and queries (not "+u.type);return function(e){return e._score=g(u.type,u.parsedQuery,r,e,!0),e}}return function(n){var s,a;for(s=0,a=e.length;a>s;s++)if(u=e[s],!g(u.type,u.parsedQuery,r,n,t))return!1;return!0}},g=function(e,r,t,n,u){var s,a,i,o,c,l,f,y,p,$;for(c=0,y=0,p=1/r.length,i=0,o=r.length;o>i;i++)switch(l=r[i],s=t?t(n,l.key):l.getter?l.getter(n,l.key):n[l.key],$=x(l.type,s),$&&($=l.parsedQuery?w([l],t,u)(n):h(l.type,l.value,s,n,t)),$&&(c++,u&&(a=null!=(f=l.boost)?f:1,y+=p*a)),e){case"$and":if(!u&&!$)return!1;break;case"$not":if($)return!1;break;case"$or":if($)return!0;break;case"$nor":if($)return!1;break;default:throw new Error("Invalid compound method")}return u?y:"$not"===e?0===c:"$or"!==e},$=function(e){var r,t,n,u,s,a,i,o,c,l;if(i=q.keys(e),!i.length)return[];for(r=q.intersection(q.compoundKeys,i),t=0,s=r.length;s>t;t++)if(c=r[t],!q.isArray(e[c])&&q.includes(q.expectedArrayQueries,c))throw new Error(c+" query must be an array");if(0===r.length)return[{type:"$and",parsedQuery:d(e)}];if(r.length!==i.length){q.includes(r,"$and")||(e.$and={},r.unshift("$and"));for(u in e)Q.call(e,u)&&(l=e[u],q.includes(q.compundKeys,u)||(e.$and[u]=l,delete e[u]))}for(o=[],n=0,a=r.length;a>n;n++)c=r[n],o.push({type:c,parsedQuery:d(e[c],c)});return o},y=function(e){var r;return"String"===q.getType(e)&&(r=e,e=function(e,t){return e[r](t)}),e},e=function(){function e(e,r){this.items=e,this._getter=r,this.theQuery={}}return e.prototype.all=function(e,r){return e&&(this.items=e),e=this.indexes?this.getIndexedItems(this.items):this.items,v(e,this.theQuery,this._getter,r)},e.prototype.chain=function(){return _.chain(this.all.apply(this,arguments))},e.prototype.tester=function(){return l(this.theQuery,this._getter)},e.prototype.first=function(e){return this.all(e,!0)},e.prototype.getter=function(e){return this._getter=e,this},e}(),r=function(e){return function(r,t){var n;return t&&(r=q.makeObj(r,t)),null==(n=this.theQuery)[e]&&(n[e]=[]),this.theQuery[e].push(r),this}},k=q.compoundKeys,a=0,o=k.length;o>a;a++)i=k[a],e.prototype[i.substr(1)]=r(i);return e.prototype.find=e.prototype.query=e.prototype.run=e.prototype.all,t=function(r,t){return new e(r,t)},l=function(e,r){return w($(e),y(r))},s=function(e,r,t){return v(e,r,t,!0)},v=function(e,r,n,u,s){var a;return arguments.length<2?t.apply(this,arguments):(n&&(n=y(n)),"Function"!==q.getType(r)&&(r=w($(r),n,s)),(a=s?q.map:u?q.find:q.filter)(e,r))},b=function(e,r,t){return v(e,r,t,!1,!0)},v.build=t,v.parse=$,v.findOne=v.first=s,v.score=b,v.tester=v.testWith=l,v.getter=v.pluckWith=q.makeGetter,u=function(e,r){return null==r&&(r=!0),n(e),r&&e.mixin({query:v,q:v}),v},m._?u(m._):exports&&("undefined"!=typeof module&&null!==module?module.exports:void 0)?module.exports=u:u}).call(this);